# setup() 函数总结

`setup()` 函数负责初始化系统的全局状态和硬件，确保系统准备就绪以进行后续操作。其主要步骤如下：

1. **初始化全局状态**
   设置 `currentStatus.initialisationComplete = false`，标记初始化未完成。

2. **调用 initialiseAll()**
   执行各项初始化工作，包括硬件外设、通信接口、传感器和执行器等。

    - 初始化微控制器外设：包括 ADC、PWM、定时器等。
    - 配置通信接口：如串口、CAN 总线。
    - 设置传感器和执行器的引脚模式：例如喷油器、点火线圈、TPS 等。
    - 加载存储的配置参数：如燃油表、点火表等。
    - 初始化实时时钟（RTC）和 SD 卡日志（若启用）。

---

# loop() 函数总结

`loop()` 函数是系统的主循环，按不同频率执行任务，核心流程包括以下几个部分：

### 1. **通信处理**
- **串口通信**：接收或发送数据，如 TunerStudio 请求。
- **CAN 通信**：处理外部传感器或执行器的 CAN 协议数据。

### 2. **引擎状态检测**
- **转速计算**：通过曲轴信号判断引擎是否运行 (`currentStatus.RPM`)。
- **同步检查**：确保曲轴/凸轮轴信号同步 (`currentStatus.hasSync`)。
- **运行模式切换**：区分启动（Cranking）和运行（Running）状态。

### 3. **传感器数据读取（多频率调度）**
- **高频（1kHz）**：读取 MAP 传感器。
- **中频（200Hz）**：触发 ADC 转换（温度、电压等）。
- **低频（15Hz/10Hz/4Hz/1Hz）**：
    - 读取 TPS、CLT（水温）、IAT（进气温度）、电池电压。
    - 处理怠速控制、空调控制、氮氧喷射等。

### 4. **燃油与点火计算**
- **燃油参数**：
    - 从 VE 表查值，计算燃油脉冲宽度 (`currentStatus.PW1`)。
    - 修正参数（温度、气压、加速增浓等）。
    - 处理分组喷射（Staging）逻辑。
- **点火参数**：
    - 从点火提前表查值，计算点火角度和闭合时间 (`currentStatus.dwell`)。
    - 处理顺序点火或分组点火模式。

### 5. **执行器控制**
- **喷油调度**：根据曲轴角度和脉冲宽度，设置喷油器的开启/关闭时间（`setFuelSchedule`）。
- **点火调度**：设置点火线圈的通电和断电时间（`setIgnitionSchedule`）。

### 6. **保护与限制逻辑**
- **超速保护**：硬切断（Hard Cut）或滚动切断（Rolling Cut）。
- **引擎保护**：检测过热、爆震等故障并限制输出。
- **启动与换挡控制**：处理弹射起步（Launch Control）和平顺换挡（Flat Shift）。

### 7. **数据记录与调试**
- **SD 卡日志**：按配置频率记录关键参数。
- **实时状态更新**：通过 LED 或串口反馈系统状态。

---

# 修正与补充说明

1. **调度机制**
   使用定时器标志（如 `BIT_TIMER_1KHZ`）实现多任务分时处理，而非简单的“时间比较器”方式。

2. **动态同步切换**
   根据喷射/点火模式（如顺序喷射），动态调整曲轴角度范围（360° 或 720°）。

3. **故障恢复**
   检测传感器异常时自动重置或降级运行（如关闭燃油泵）。

4. **硬件优化**
   针对高转速场景优化计算，快速将角度转换为时间，以提高计算效率。
